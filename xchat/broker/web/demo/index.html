<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CM</title>
</head>
<body>
<h1>XChat</h1>
<p>Open JavaScript console to watch output.</p>
<div id="msg"></div>
<script>AUTOBAHN_DEBUG = true;</script>
<script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

<script>
    // the URL of the WAMP Router (Crossbar.io)
    //
    var wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";

    function onchallenge (session, method, extra) {
        console.log("onchallenge", method, extra);
        if (method === "jwt") {
            return "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NjYyMTgwNDgsInVzZXJuYW1lIjoidGVzdCIsInVzZXIiOiJ0ZXN0In0.b0Pcf-ANG86sXE4cfkV_6cHw84gjyMOV80bLqEZSPFw";
        } else {
            throw "don't know how to authenticate using '" + method + "'";
        }
    }

    // the WAMP connection to the Router
    //
    var connection = new autobahn.Connection({
        url: wsuri,
        realm: "xchat",
        authmethods: ["jwt"],
        onchallenge: onchallenge
    });

    var session = null;
    var reply_sub = null;
    var msg_sub = null;

    // fired when connection is established and session attached
    connection.onopen = function (newSession, details) {
        session = newSession;
        console.log("Connected");
        console.log("session:", session);
        console.log("details:", details);

        function onMsg (args, kwargs) {
          console.log(">>>>msg:", args, kwargs);
          var msg_div = document.getElementById("msg");
          var p = document.createElement("p");
          var msg = args[0];
          p.innerHTML = msg.chat_id + ":" + msg.msgs[0].msg;
          msg_div.appendChild(p);
        }
        session.subscribe('xchat.user.' + session.id + '.msg', onMsg).then(
          function (sub) {
            msg_sub = sub;
            console.log('subscribed to topic');
          },
          function (err) {
            console.error('failed to subscribe to topic', err);
          }
        );
    };

    // fired when connection was lost (or could not be established)
    //
    connection.onclose = function (reason, details) {
        console.log("Connection lost")
        console.log("reason:", reason)
        console.log("details:", details)
        reply_sub = null;
        msg_sub = null;
        session = null;
    };

    // now actually open the connection
    connection.open();
</script>
</body>
</html>
