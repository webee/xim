<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CM</title>
</head>
<body>
<h1>XChat</h1>
<p>Open JavaScript console to watch output.</p>
<form onsubmit="return false">
  <input id="chat_id" size=6 type="text" value="1"></input>
<input id="send" size="75" type="text"></input><input type="submit" onclick="sendMsg()" value="发送"></input>
</form>
<div id="msg">
  <p>start</p>
</div>
<script>AUTOBAHN_DEBUG = true;</script>
<script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

<script>
    // the URL of the WAMP Router (Crossbar.io)
    //
    var wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";

    function onchallenge (session, method, extra) {
        console.log("onchallenge", method, extra);
        if (method === "jwt") {
            return "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NjYyMTgwNDgsInVzZXJuYW1lIjoidGVzdCIsInVzZXIiOiJ0ZXN0In0.b0Pcf-ANG86sXE4cfkV_6cHw84gjyMOV80bLqEZSPFw";
        } else {
            throw "don't know how to authenticate using '" + method + "'";
        }
    }

    // the WAMP connection to the Router
    //
    var connection = new autobahn.Connection({
        url: wsuri,
        realm: "xchat",
        authmethods: ["jwt"],
        onchallenge: onchallenge
    });

    var session = null;
    var reply_sub = null;
    var msg_sub = null;

    function sendMsg() {
      if (!session) {
        return
      }

      var chat_id = parseInt(document.getElementById("chat_id").value);
      var txt = document.getElementById("send");
      var content = txt.value;
      if (content.length === 0) {
        alert("消息不能为空");
        return
      }

      session.call('xchat.user.msg.send', [chat_id, content]).then(
        function(res) {
          console.log("res:", res);
          var args = res.args;
          if (args[0]) {
            newMsg({chat_id: chat_id, user:"*test*", id: args[1], ts: args[2], msg: content});
            txt.value = "";
          } else {
            alert("error:" + args[2]);
          }
        },
        function(err) {
          console.error("err:", err);
          alert("send error");
        }
      );
    }

    function testPing(n) {
      session.call('xchat.ping', [n||0]).then(res=>console.log("res:", res), err=>console.error("err:", err));
    }

    function testSendMsg(s, chat_id, i, n, show) {
      if (i<n) {
        var content = s + i;
        session.call('xchat.user.msg.send', [chat_id, content]).then(
          res=>{
            console.log("res:", res);
            var args = res.args;
            if (args[0]) {
              if (show) {
                newMsg({chat_id: chat_id, user:"*test*", id: args[1], ts: args[2], msg: content});
              }
            } else {
              console.error("error:" + args[2]);
            }
            testSendMsg(s, chat_id, i+1, n);
          }).catch(
          err=>{
            console.error("err:", err);
            testSendMsg(s, chat_id, i+1, n);
          }
        );
      }
    }

    function newMsg(msg) {
        var msg_div = document.getElementById("msg");
        var p = document.createElement("p");
        p.innerHTML = msg.ts + "->#" + msg.chat_id + "#" + msg.id + "#" + msg.user+ ": " + msg.msg;
        msg_div.insertBefore(p, msg_div.firstChild);
    }

    // fired when connection is established and session attached
    connection.onopen = function (newSession, details) {
        session = newSession;
        console.log("Connected");
        console.log("session:", session);
        console.log("details:", details);

        function onMsg (args, kwargs) {
          console.log(">>>>msg:", args, kwargs);
          var msgs = args[0];
          for (i=0; i < msgs.length; i++) {
            newMsg(msgs[i]);
          }
        }
        session.subscribe('xchat.user.' + session.id + '.msg', onMsg).then(
          function (sub) {
            msg_sub = sub;
            console.log('subscribed to topic');
          },
          function (err) {
            console.error('failed to subscribe to topic', err);
          }
        );
    };

    // fired when connection was lost (or could not be established)
    //
    connection.onclose = function (reason, details) {
        console.log("Connection lost")
        console.log("reason:", reason)
        console.log("details:", details)
        reply_sub = null;
        msg_sub = null;
        session = null;
    };

    // now actually open the connection
    connection.open();
</script>
</body>
</html>
