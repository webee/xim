<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CM</title>
</head>
<body>
<h1>XChat</h1>
<p>Open JavaScript console to watch output.</p>
<form onsubmit="return false">
  <input id="chat_id" size=12 type="text" value="group.1"></input>
<input id="send" size="75" type="text"></input><input type="submit" onclick="sendMsg()" value="发送"></input>
</form>
<div id="msg">
  <p>start</p>
</div>
<script language="JavaScript" type="text/javascript" src="http://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
<script>AUTOBAHN_DEBUG = true;</script>
<script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

<script>
    if (!String.prototype.format) {
      String.prototype.format = function() {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function(match, number) {
          return typeof args[number] != 'undefined'
            ? args[number]
            : match
          ;
        });
      };
    }

    var userkey = "demo app user key.";
    var user = document.location.hash.substr(1)||"test";
    var jwt = document.location.search.substr(1);
    // the URL of the WAMP Router (Crossbar.io)
    //
    var wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";

    function onchallenge (session, method, extra) {
        console.log("onchallenge", method, extra);
        if (method === "jwt") {
            if (!!jwt) {
              return jwt
            }
            // Header
            var oHeader = {alg: 'HS256', typ: 'JWT'};
            // Payload
            var oPayload = {};
            var tEnd = KJUR.jws.IntDate.get('now + 1day');
            oPayload.exp = tEnd;
            oPayload.user = user;

            // Sign JWT, password=616161
            var sHeader = JSON.stringify(oHeader);
            var sPayload = JSON.stringify(oPayload);

            return KJUR.jws.JWS.sign("HS256", sHeader, sPayload, userkey);
        } else {
            throw "don't know how to authenticate using '" + method + "'";
        }
    }

    // the WAMP connection to the Router
    //
    var connection = new autobahn.Connection({
        url: wsuri,
        realm: "xchat",
        authmethods: ["jwt"],
        onchallenge: onchallenge
    });

    var session = null;
    var reply_sub = null;
    var msg_sub = null;
    var do_update = true;

    function sendMsg() {
      if (!session) {
        return
      }

      var chat_id = document.getElementById("chat_id").value;
      var txt = document.getElementById("send");
      var content = txt.value;
      if (content.length === 0) {
        alert("消息不能为空");
        return
      }

      session.call('xchat.user.msg.send', [chat_id, content]).then(
        function(res) {
          console.log("res:", res);
          var args = res.args;
          if (args[0]) {
            newMsg("chat", {chat_id: chat_id, user:"*"+user+"*", id: args[1], ts: args[2], msg: content});
            txt.value = "";
          } else {
            alert("error:" + args[2]);
          }
        },
        function(err) {
          console.error("err:", err);
          alert("send error");
        }
      );
    }

    function testPing(n) {
      session.call('xchat.ping', [n||0]).then(res=>console.log("res:", res), err=>console.error("err:", err));
    }

    function testSendMsg(s, chat_id, i, n, show) {
      if (i<n) {
        var content = s.format(i);
        session.call('xchat.user.msg.send', [chat_id, content]).then(
          res=>{
            console.log("res:", res);
            var args = res.args;
            if (args[0]) {
              if (show) {
                newMsg("chat", {chat_id: chat_id, user:"*test*", id: args[1], ts: args[2], msg: content});
              }
            } else {
              console.error("error:" + args[2]);
            }
            testSendMsg(s, chat_id, i+1, n, show);
          }).catch(
          err=>{
            console.error("err:", err);
            testSendMsg(s, chat_id, i+1, n, show);
          }
        );
      }
    }

    function testSendNotify(s, chat_id, i, n, interval) {
      if (i<n) {
        var content = s + i;
        session.publish('xchat.user.msg.pub', [chat_id, content]);
        interval = interval || 100
        setTimeout(function(){
          testSendNotify(s, chat_id, i+1, n, interval);
        }, interval);
      }
    }

    function update_on() {
      do_update = true;
      return do_update;
    }

    function update_off() {
      do_update = false;
      return do_update;
    }

    function newMsg(kind, msg) {
      if (do_update) {
        var msg_div = document.getElementById("msg");
        var p = document.createElement("p");
        if (kind==="chat") {
          p.innerHTML = msg.ts + ": [" + kind + "]" + msg.chat_id + "@" + msg.user+ ">" + msg.id + " : " + msg.msg;
        } else if (kind==="chat_notify") {
          p.innerHTML = msg.ts + ": [" + kind + "]" + msg.chat_id + "@" + msg.user+ " : " + msg.msg;
        }
        msg_div.insertBefore(p, msg_div.firstChild);
      }
    }

    // fired when connection is established and session attached
    connection.onopen = function (newSession, details) {
        session = newSession;
        console.log("Connected");
        console.log("session:", session);
        console.log("details:", details);

        function onMsg (args, kwargs) {
          console.log(">>>>msg:", args, kwargs);
          var kind = args[0];
          var msgs = args[1];
          for (i=0; i < msgs.length; i++) {
            newMsg(kind, msgs[i]);
          }
        }
        session.subscribe('xchat.user.' + session.id + '.msg', onMsg).then(
          function (sub) {
            msg_sub = sub;
            console.log('subscribed to topic');
          },
          function (err) {
            console.error('failed to subscribe to topic', err);
          }
        );
    };

    // fired when connection was lost (or could not be established)
    //
    connection.onclose = function (reason, details) {
        console.log("Connection lost")
        console.log("reason:", reason)
        console.log("details:", details)
        reply_sub = null;
        msg_sub = null;
        session = null;
    };

    // now actually open the connection
    connection.open();
</script>
</body>
</html>
